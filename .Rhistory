        #                                 quintile = "Q1"))
        #   }
        # }
        # for(m in 1:nrow(quart1)){
        #   currentId = quart1$userId[m]
        #   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
        #   if(quart1$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
        #     if(quart1$specialty[m] != "General") {
        #       quart1$group[m] = "SMEs"
        #     } else{
        #       quart1$group[m] = "x-risk generalists"
        #     }
        #   }
        #   #print(forecast)
        #   if(length(forecast)>0){
        #     tbl = rbind(tbl, data.frame(userType = quart1[m,]$group,
        #                                 forecast = forecast,
        #                                 quintile = "Q1"))
        #   }
        # }
        for (m in 1:nrow(q2)) {
          currentId <- q2$userId[m]
          forecast <- (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
          #     if(q2$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #        if(q2$specialty1[m] != "General"){
          #           q2$group[m] = "SMEs"
          #   } else{
          #     q2$group[m] = "x-risk generalists"
          #   }
          # }
          #       if(q2$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #          if(specialty %in% c(q2$specialty1[m], q2$specialty2[m]) & specialty != ""){
          #                              q2$group[m] = "domain experts"
          #     } else if(q2$specialty1[m] != "General"){
          #               q2$group[m] = "non-domain experts"
          #   } else{
          #     q2$group[m] = "x-risk generalists"
          #   }
          # }
          # if(q2$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #   if(specialty %in% c(q2$specialty1[m], q2$specialty2[m])){
          #     q2$group[m] = "domain experts"
          #   } else{
          #     q2$group[m] = "non-domain experts"
          #   }
          # }
          # print(forecast)
          # if(q2$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #   if(q2$specialty[m] != "General") {
          #     q2$group[m] = "SMEs"
          #   } else{
          #     q2$group[m] = "x-risk generalists"
          #   }
          # }
          if (length(forecast) > 0) {
            tbl <- rbind(tbl, data.frame(
              userType = q2[m, ]$group,
              forecast = forecast,
              quintile = "Q2"
            ))
          }
        }
        # for(m in 1:nrow(q2_supers)){
        #   currentId = q2_supers$userId[m]
        #   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
        #   #print(forecast)
        #   if(length(forecast)>0){
        #     tbl = rbind(tbl, data.frame(userType = q2_supers[m,]$group,
        #                                 forecast = forecast,
        #                                 quintile = "Q2"))
        #   }
        # }
        #
        # for(m in 1:nrow(q2_experts)){
        #   currentId = q2_experts$userId[m]
        #   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
        #   #print(forecast)
        #   if(length(forecast)>0){
        #     tbl = rbind(tbl, data.frame(userType = q2_experts[m,]$group,
        #                                 forecast = forecast,
        #                                 quintile = "Q2"))
        #   }
        # }
        # for(m in 1:nrow(quart2)){
        #   currentId = quart2$userId[m]
        #   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
        #   if(quart2$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
        #     if(quart2$specialty[m] != "General") {
        #       quart2$group[m] = "SMEs"
        #     } else{
        #       quart2$group[m] = "x-risk generalists"
        #     }
        #   }
        #   #print(forecast)
        #   if(length(forecast)>0){
        #     tbl = rbind(tbl, data.frame(userType = quart2[m,]$group,
        #                                 forecast = forecast,
        #                                 quintile = "Q2"))
        #   }
        # }
        for (m in 1:nrow(q3)) {
          currentId <- q3$userId[m]
          forecast <- (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
          #     if(q3$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #        if(q3$specialty1[m] != "General"){
          #           q3$group[m] = "SMEs"
          #   } else{
          #     q3$group[m] = "x-risk generalists"
          #   }
          # }
          #       if(q3$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #          if(specialty %in% c(q3$specialty1[m], q3$specialty2[m]) & specialty != ""){
          #                              q3$group[m] = "domain experts"
          #     } else if(q3$specialty1[m] != "General"){
          #               q3$group[m] = "non-domain experts"
          #   } else{
          #     q3$group[m] = "x-risk generalists"
          #   }
          # }
          #     if(q3$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #        if(specialty %in% c(q3$specialty1[m], q3$specialty2[m])){
          #                            q3$group[m] = "domain experts"
          #   } else{
          #     q3$group[m] = "non-domain experts"
          #   }
          # }
          # print(forecast)
          # if(q3$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #   if(q3$specialty[m] != "General") {
          #     q3$group[m] = "SMEs"
          #   } else{
          #     q3$group[m] = "x-risk generalists"
          #   }
          # }
          if (length(forecast) > 0) {
            tbl <- rbind(tbl, data.frame(
              userType = q3[m, ]$group,
              forecast = forecast,
              quintile = "Q3"
            ))
          }
        }
        # for(m in 1:nrow(q3_supers)){
        #   currentId = q3_supers$userId[m]
        #   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
        #   #print(forecast)
        #   if(length(forecast)>0){
        #     tbl = rbind(tbl, data.frame(userType = q3_supers[m,]$group,
        #                                 forecast = forecast,
        #                                 quintile = "Q3"))
        #   }
        # }
        #
        # for(m in 1:nrow(q3_experts)){
        #   currentId = q3_experts$userId[m]
        #   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
        #   #print(forecast)
        #   if(length(forecast)>0){
        #     tbl = rbind(tbl, data.frame(userType = q3_experts[m,]$group,
        #                                 forecast = forecast,
        #                                 quintile = "Q3"))
        #   }
        # }
        # for(m in 1:nrow(quart3)){
        #   currentId = quart3$userId[m]
        #   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
        #   if(quart3$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
        #     if(quart3$specialty[m] != "General") {
        #       quart3$group[m] = "SMEs"
        #     } else{
        #       quart3$group[m] = "x-risk generalists"
        #     }
        #   }
        #   #print(forecast)
        #   if(length(forecast)>0){
        #     tbl = rbind(tbl, data.frame(userType = quart3[m,]$group,
        #                                 forecast = forecast,
        #                                 quintile = "Q3"))
        #   }
        # }
        for (m in 1:nrow(q4)) {
          currentId <- q4$userId[m]
          forecast <- (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
          #     if(q4$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #        if(q4$specialty1[m] != "General"){
          #           q4$group[m] = "SMEs"
          #   } else{
          #     q4$group[m] = "x-risk generalists"
          #   }
          # }
          #       if(q4$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #          if(specialty %in% c(q4$specialty1[m], q4$specialty2[m]) & specialty != ""){
          #                              q4$group[m] = "domain experts"
          #     } else if(q4$specialty1[m] != "General"){
          #               q4$group[m] = "non-domain experts"
          #   } else{
          #     q4$group[m] = "x-risk generalists"
          #   }
          # }
          #   if(q4$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #      if(specialty %in% c(q4$specialty1[m], q4$specialty2[m])){
          #                          q4$group[m] = "domain experts"
          #   } else{
          #   q4$group[m] = "non-domain experts"
          #   }
          # }
          # print(forecast)
          # if(q4$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #   if(q4$specialty[m] != "General") {
          #     q4$group[m] = "SMEs"
          #   } else{
          #     q4$group[m] = "x-risk generalists"
          #   }
          # }
          if (length(forecast) > 0) {
            tbl <- rbind(tbl, data.frame(
              userType = q4[m, ]$group,
              forecast = forecast,
              quintile = "Q4"
            ))
          }
        }
        # for(m in 1:nrow(q4_supers)){
        #   currentId = q4_supers$userId[m]
        #   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
        #   #print(forecast)
        #   if(length(forecast)>0){
        #     tbl = rbind(tbl, data.frame(userType = q4_supers[m,]$group,
        #                                 forecast = forecast,
        #                                 quintile = "Q4"))
        #   }
        # }
        #
        # for(m in 1:nrow(q4_experts)){
        #   currentId = q4_experts$userId[m]
        #   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
        #   #print(forecast)
        #   if(length(forecast)>0){
        #     tbl = rbind(tbl, data.frame(userType = q4_experts[m,]$group,
        #                                 forecast = forecast,
        #                                 quintile = "Q4"))
        #   }
        # }
        # for(m in 1:nrow(quart4)){
        #   currentId = quart4$userId[m]
        #   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
        #   if(quart4$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
        #     if(quart4$specialty[m] != "General") {
        #       quart4$group[m] = "SMEs"
        #     } else{
        #       quart4$group[m] = "x-risk generalists"
        #     }
        #   }
        #   #print(forecast)
        #   if(length(forecast)>0){
        #     tbl = rbind(tbl, data.frame(userType = quart4[m,]$group,
        #                                 forecast = forecast,
        #                                 quintile = "Q4"))
        #   }
        # }
        for (m in 1:nrow(q5)) {
          currentId <- q5$userId[m]
          forecast <- (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
          #     if(q5$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #        if(q5$specialty1[m] != "General"){
          #           q5$group[m] = "SMEs"
          #   } else{
          #     q5$group[m] = "x-risk generalists"
          #   }
          # }
          #       if(q5$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #          if(specialty %in% c(q5$specialty1[m], q5$specialty2[m]) & specialty != ""){
          #                              q5$group[m] = "domain experts"
          #     } else if(q5$specialty1[m] != "General"){
          #               q5$group[m] = "non-domain experts"
          #   } else{
          #     q5$group[m] = "x-risk generalists"
          #   }
          # }
          #     if(q5$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #        if(specialty %in% c(q5$specialty1[m], q5$specialty2[m])){
          #                            q5$group[m] = "domain experts"
          #   } else{
          #     q5$group[m] = "non-domain experts"
          #   }
          # }
          # print(forecast)
          # if(q5$group[m] %in% c("experts", "domain experts", "non-domain experts", "x-risk generalists", "SMEs")){
          #   if(q5$specialty[m] != "General") {
          #     q5$group[m] = "SMEs"
          #   } else{
          #     q5$group[m] = "x-risk generalists"
          #   }
          # }
          if (length(forecast) > 0) {
            tbl <- rbind(tbl, data.frame(
              userType = q5[m, ]$group,
              forecast = forecast,
              quintile = "Q5"
            ))
          }
        }
        # for(m in 1:nrow(q5_supers)){
        #   currentId = q5_supers$userId[m]
        #   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
        #   #print(forecast)
        #   if(length(forecast)>0){
        #     tbl = rbind(tbl, data.frame(userType = q5_supers[m,]$group,
        #                                 forecast = forecast,
        #                                 quintile = "Q5"))
        #   }
        # }
        #
        # for(m in 1:nrow(q5_experts)){
        #   currentId = q5_experts$userId[m]
        #   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
        #   #print(forecast)
        #   if(length(forecast)>0){
        #     tbl = rbind(tbl, data.frame(userType = q5_experts[m,]$group,
        #                                 forecast = forecast,
        #                                 quintile = "Q5"))
        #   }
        # }
        tbl$quintile <- factor(tbl$quintile, levels = unique(tbl$quintile), ordered = TRUE)
        # tbl$userType[tbl$userType=="general"] = "x-risk generalists"
        # tbl$userType = factor(tbl$userType, levels=unique(tbl$userType), ordered=TRUE)
        tbl$userType <- factor(tbl$userType, levels = c("supers", "experts"), ordered = TRUE)
        # tbl$userType = factor(tbl$userType, levels=c("supers", "domain experts", "non-domain experts"), ordered=TRUE)
        # tbl$userType = factor(tbl$userType, levels=c("supers", "SMEs", "x-risk generalists"), ordered=TRUE)
        title <- paste(currentSetName, "by", years[k])
        subtitle <- paste("Stage", j, "|", beliefSets[l], "|", "RS Accuracy (Unincentivized, First 10)")
        # subtitle = paste("Stage", j, "|", beliefSets[l], "|", "By RS Accuracy (based on RS answers) - quintiles split by supers+experts into original rank")
        plot <- rs_quintile_plot(tbl)
        if (dir.exists("RS Accuracy")) {
          setwd("RS Accuracy")
        } else {
          dir.create("RS Accuracy")
          setwd("RS Accuracy")
        }
        ggsave(paste0(title, "-", subtitle, ".png"), plot, width = 3600, height = 2000, units = c("px"))
        setwd(paste0(yourHome, "Summary Data/RS Accuracy"))
        ggsave(paste0(title, "-", subtitle, ".png"), plot, width = 3600, height = 2000, units = c("px"))
        setwd(paste0(yourHome, "Summary Data/", currentSetName, "/Phase Data/", years[k]))
      }
      setwd(paste0(yourHome, "Summary Data/", currentSetName, "/Phase Data"))
    }
    setwd(paste0(yourHome, "Summary Data/", currentSetName, "/Phase Data"))
  }
  setwd(paste0(yourHome, "Summary Data"))
}
# setwd("~/Documents/persuasion tournament/in-progress analysis/Summary Data/4. AI Extinction Risk/Phase Data/2100/(Your Beliefs)")
#
# csv = read.csv("4. AI Extinction Risk - 2100 (Your Beliefs) - Phase 1.csv")
# csv = csv %>% filter(userId %in% rs_rank$userId)
#
# tbl = data.frame(userType = character(0),
#                  forecast = numeric(0),
#                  quintile = character(0))
#
# for(i in 1:nrow(q1)){
#   currentId = q1$userId[i]
#   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
#   print(forecast)
#   if(length(forecast)>0){
#     tbl = rbind(tbl, data.frame(userType = q1[i,]$group,
#                                 forecast = forecast,
#                                 quintile = "Q1"))
#   }
# }
#
# for(i in 1:nrow(q2)){
#   currentId = q2$userId[i]
#   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
#   print(forecast)
#   if(length(forecast)>0){
#     tbl = rbind(tbl, data.frame(userType = q2[i,]$group,
#                                 forecast = forecast,
#                                 quintile = "Q2"))
#   }
# }
#
# for(i in 1:nrow(q3)){
#   currentId = q3$userId[i]
#   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
#   print(forecast)
#   if(length(forecast)>0){
#     tbl = rbind(tbl, data.frame(userType = q3[i,]$group,
#                                 forecast = forecast,
#                                 quintile = "Q3"))
#   }
# }
#
# for(i in 1:nrow(q4)){
#   currentId = q4$userId[i]
#   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
#   print(forecast)
#   if(length(forecast)>0){
#     tbl = rbind(tbl, data.frame(userType = q4[i,]$group,
#                                 forecast = forecast,
#                                 quintile = "Q4"))
#   }
# }
#
# for(i in 1:nrow(q5)){
#   currentId = q5$userId[i]
#   forecast = (csv %>% filter(userId == currentId) %>% select(forecast))$forecast
#   print(forecast)
#   if(length(forecast)>0){
#     tbl = rbind(tbl, data.frame(userType = q5[i,]$group,
#                                 forecast = forecast,
#                                 quintile = "Q5"))
#   }
# }
#
# tbl$quintile = factor(tbl$quintile, levels=unique(tbl$quintile), ordered=TRUE)
# tbl$userType = factor(tbl$userType, levels=unique(tbl$userType), ordered=TRUE)
#
# plot = ggplot(tbl, aes(x=quintile, y=forecast, group=quintile)) +
#   geom_boxplot(outlier.shape=NA) +
#   ylab("Forecast") +
#   xlab("Quintile") +
#   labs(title = "AI Extinction Risk by 2100", subtitle = "By RS Accuracy") +
#   theme_bw() +
#   coord_trans(y=pseudo_log_trans(base=10), ylim = c(0, 100)) +
#   scale_y_continuous(breaks = c(0, 0.5, 1, 10, 25, 50, 75, 100)) +
#   scale_color_manual(values=hue_pal()(3)) +
#   theme(plot.title = element_text(hjust = 0.5),
#         plot.subtitle = element_text(hjust = 0.5),
#         legend.title = element_text(size=9, vjust=-37)) +
#   geom_point(position=position_jitterdodge(), aes(x=quintile, y=forecast, color=userType)) +
#   geom_label(aes(x=1, y=median((tbl %>% filter(quintile == "Q1") %>% select(forecast))$forecast), label=median((tbl %>% filter(quintile == "Q1") %>% select(forecast))$forecast))) +
#   geom_label(aes(x=2, y=median((tbl %>% filter(quintile == "Q2") %>% select(forecast))$forecast), label=median((tbl %>% filter(quintile == "Q2") %>% select(forecast))$forecast))) +
#   geom_label(aes(x=3, y=median((tbl %>% filter(quintile == "Q3") %>% select(forecast))$forecast), label=median((tbl %>% filter(quintile == "Q3") %>% select(forecast))$forecast))) +
#   geom_label(aes(x=4, y=median((tbl %>% filter(quintile == "Q4") %>% select(forecast))$forecast), label=median((tbl %>% filter(quintile == "Q4") %>% select(forecast))$forecast))) +
#   geom_label(aes(x=5, y=median((tbl %>% filter(quintile == "Q5") %>% select(forecast))$forecast), label=median((tbl %>% filter(quintile == "Q5") %>% select(forecast))$forecast)))
# plot$labels$colour = ""
#
# setwd(paste0(yourHome, "Summary Data"))
#
# ggsave("2100 AI Extinction Risk by RS Accuracy.png", plot, width=3600, height=2000, units=c("px"))
# Set-up
rm(list = ls())
options(scipen = 999)
setwd(paste0(yourHome, "/sources"))
library(data.table)
library(lubridate)
library(dplyr)
library(ggplot2)
library(scales)
library(timetk)
library(xpt)
yourHome <<- "~/fri/xpt-basic-analysis/"
data <- fread("FORECASTS.csv")
data$timestamp <- ymd_hms(data$timestamp)
data$stageOneTimestamp <- mdy_hms(data$stageOneTimestamp)
data$stageTwoTimestamp <- mdy_hms(data$stageTwoTimestamp)
data$stageThreeTimestamp <- mdy_hms(data$stageThreeTimestamp)
data$stageFourTimestamp <- mdy_hms(data$stageFourTimestamp)
data$forecast <- as.numeric(data$forecast)
supers <- fread("archive.csv")
supers <- supers %>%
  select(userName, userId, teamName) %>%
  filter(grepl("super", teamName))
supers <- unique(supers)
supers <- supers$userName
# expertsG1 = fread("archive.csv")
# expertsG1 = expertsG1 %>% select(userName, userId, teamName) %>% filter(grepl("expertsG1", teamName))
# expertsG1 = unique(expertsG1)
# expertsG1$specialty = ""
# special = fread("special.csv")
# for(i in 1:nrow(expertsG1)){
#   current = filter(special, User_ID == expertsG1$userId[i])
#   expertsG1$specialty[i] = current$specialty
# }
# expertsG1 = select(expertsG1, userName, userId, specialty)
expertsG1 <- read.csv("expertsG1.csv")
expertsG2 <- fread("archive.csv")
expertsG2 <- expertsG2 %>%
  select(userName, userId, teamName) %>%
  filter(grepl("expertsG2", teamName))
expertsG2 <- unique(expertsG2)
expertsG2 <- expertsG2$userName
teams <- data %>% select(userName, userId, teamName, teamId)
teams <- unique(teams)
meta <- fread("questionMetadata.csv")
# meta = fread("GDPGrowthMetadata.csv")
questionTypes <- unique(meta$questionType)
setwd(paste0(yourHome, "Summary Data"))
startDate <- (data %>% select(timestamp) %>% arrange(timestamp) %>% filter(!is.na(timestamp)))$timestamp[1]
startDate <- ymd(paste(year(startDate), month(startDate), day(startDate)))
phaseTwoMedian <- (data %>% select(stageTwoTimestamp) %>% arrange(stageTwoTimestamp) %>% filter(!is.na(stageTwoTimestamp)))$stageTwoTimestamp
phaseTwoMedian <- median(phaseTwoMedian)
phaseTwoMedian <- ymd(paste(year(phaseTwoMedian), month(phaseTwoMedian), day(phaseTwoMedian)))
endDate <- ymd("2022 10 31")
timeline <- seq(startDate, endDate, 1)
summaryTable <- read.csv("summaryTable.csv")
rs_rank <- read.csv("RSRanking_unincentivized_first10.csv")
rs_rank <- rs_rank %>%
  filter(n >= 30) %>%
  filter(group %in% c("supers", "domain experts", "non-domain experts"))
#rs_rank$group[rs_rank$group %in% c("domain experts", "non-domain experts")] <- "experts"
rs_rank <- arrange(rs_rank, avgRank)
rs_rank <- mutate(rs_rank, specialty1 = "", specialty2 = "")
for (i in 1:nrow(rs_rank)) {
  if (rs_rank$group[i] == "experts" & rs_rank$userId[i] %in% expertsG1$userId) {
    rs_rank$specialty1[i] <- expertsG1[expertsG1$userId == rs_rank$userId[i], ]$specialty1
    rs_rank$specialty2[i] <- expertsG1[expertsG1$userId == rs_rank$userId[i], ]$specialty2
  }
}
getwd()
setwd('/home/molly/fri/xpt')
devtools::install()
